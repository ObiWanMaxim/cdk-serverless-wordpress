"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LambdaWordpressStack = void 0;
const cdk = require("@aws-cdk/core");
const ec2 = require("@aws-cdk/aws-ec2");
const efs = require("@aws-cdk/aws-efs");
const lambda = require("@aws-cdk/aws-lambda");
const rds = require("@aws-cdk/aws-rds");
const elbv2 = require("@aws-cdk/aws-elasticloadbalancingv2");
const targets = require("@aws-cdk/aws-elasticloadbalancingv2-targets");
const cm = require("@aws-cdk/aws-certificatemanager");
const aws_elasticloadbalancingv2_1 = require("@aws-cdk/aws-elasticloadbalancingv2");
const path = require("path");
class LambdaWordpressStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        var DB_HOST = null;
        var HTTP_HOST = null;
        const DB_NAME = 'wordpress';
        const DB_USER = 'wordpressuser';
        const BASE_PATH = '/mnt/efs';
        const ACCESSPOINT_PATH = '/wordpress';
        const WORDPRESS_PATH = '/mnt/efs';
        const KEY_NAME = this.node.tryGetContext('keyName');
        const DOMAIN_NAME = this.node.tryGetContext('domainName');
        const DB_PASSWORD = this.node.tryGetContext('dbPassword');
        //set the certificate
        const myCertificate = new cm.Certificate(this, 'myCertificate', {
            domainName: DOMAIN_NAME,
            validation: cm.CertificateValidation.fromDns(),
        });
        //create VPC 
        const serverlessVPC = new ec2.Vpc(this, 'serverlessWordpressVPC', {
            cidr: '10.0.0.0/16',
            subnetConfiguration: [
                {
                    subnetType: ec2.SubnetType.PUBLIC,
                    name: 'public',
                    cidrMask: 24,
                },
                {
                    cidrMask: 24,
                    name: 'private',
                    subnetType: ec2.SubnetType.PRIVATE,
                },
            ],
        });
        /**
         * create security group in VPC
         */
        // NFS security group which used for ec2 to copy file
        const sgNFSSG = new ec2.SecurityGroup(this, 'NFSAllowAllSG', {
            vpc: serverlessVPC,
            description: 'allow 2049 inbound for ec2',
            allowAllOutbound: true,
        });
        sgNFSSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(2049), 'allow 2049 inbound from ec2');
        //ALB security group which allow 80 and 443
        const albSG = new ec2.SecurityGroup(this, 'albSG', {
            vpc: serverlessVPC,
            description: 'allow 80 and 443',
            allowAllOutbound: true,
        });
        albSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(80), 'allow 80 inbound');
        albSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(443), 'allow 443 inbound');
        //EC2 security group which allow port 22
        const ec2SG = new ec2.SecurityGroup(this, 'ec2SG', {
            vpc: serverlessVPC,
            description: 'allow 22 inbound for ec2',
            allowAllOutbound: true,
        });
        ec2SG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(22), 'allow 22 inbound from ec2');
        // RDS security group which allow port 3306
        const rdsSG = new ec2.SecurityGroup(this, 'wordpressRdsSecurityGroup', {
            vpc: serverlessVPC,
            description: 'allow 3306 inbound',
            allowAllOutbound: true,
        });
        rdsSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(3306), 'allow 3306 inbound from lambda');
        /**
         * create EFS attached on Lambda
         */
        const fileSystem = new efs.FileSystem(this, 'wordpressEFS', {
            vpc: serverlessVPC,
            encrypted: false,
            performanceMode: efs.PerformanceMode.GENERAL_PURPOSE,
            throughputMode: efs.ThroughputMode.BURSTING,
            securityGroup: sgNFSSG,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        //create access point on efs
        const accessPoint = fileSystem.addAccessPoint('LambdaAccessPoint', {
            path: ACCESSPOINT_PATH,
            createAcl: {
                ownerUid: '1000',
                ownerGid: '1000',
                permissions: '0777',
            },
            posixUser: {
                uid: '1000',
                gid: '1000',
            },
        });
        /**
         * Create lambda function
         */
        const lambdaFunc = new lambda.Function(this, 'wordpressLambdaFUnction', {
            code: lambda.Code.fromAsset(path.join(__dirname, 'phpLambdaFunc')),
            handler: 'handler.php',
            memorySize: 1024,
            timeout: cdk.Duration.minutes(15),
            tracing: lambda.Tracing.ACTIVE,
            runtime: lambda.Runtime.PROVIDED,
            layers: [lambda.LayerVersion.fromLayerVersionArn(this, 'customPhpLayer', 'arn:aws:lambda:us-east-1:887080169480:layer:php73:3')],
            vpc: serverlessVPC,
            filesystem: lambda.FileSystem.fromEfsAccessPoint(accessPoint, BASE_PATH),
        });
        /*
         * create alb and integrate it with lambda
         */
        const lb = new elbv2.ApplicationLoadBalancer(this, 'serverlessALB', {
            vpc: serverlessVPC,
            internetFacing: true,
            securityGroup: albSG,
        });
        const lambdaTarget = new targets.LambdaTarget(lambdaFunc);
        const albTargetGroup = new elbv2.ApplicationTargetGroup(this, 'albTargetGroup', {
            targets: [lambdaTarget],
        });
        albTargetGroup.setAttribute('lambda.multi_value_headers.enabled', 'true');
        const listener80 = lb.addListener('Listener80', {
            port: 80,
            open: true,
        });
        listener80.addAction('80action', {
            action: aws_elasticloadbalancingv2_1.ListenerAction.forward([albTargetGroup])
        });
        const listener443 = lb.addListener('Listener443', {
            port: 443,
            open: true,
            certificateArns: [myCertificate.certificateArn],
        });
        listener443.addAction('443action', {
            action: aws_elasticloadbalancingv2_1.ListenerAction.forward([albTargetGroup])
        });
        /**
         * create RDS
         */
        const secret = cdk.SecretValue.plainText(DB_PASSWORD);
        const auroraServerlessCluster = new rds.DatabaseCluster(this, 'ServerlessWordpressAuroraCluster', {
            engine: rds.DatabaseClusterEngine.AURORA_MYSQL,
            masterUser: {
                username: DB_USER,
                password: secret,
            },
            removalPolicy: cdk.RemovalPolicy.DESTROY,
            instanceProps: {
                vpc: serverlessVPC,
                securityGroups: [rdsSG],
            },
            defaultDatabaseName: DB_NAME,
        });
        /***
         *  set the DB_HOST and HTTP_HOST which will used in the lambda environment
         */
        DB_HOST = auroraServerlessCluster.clusterEndpoint.hostname;
        HTTP_HOST = lb.loadBalancerDnsName;
        //SET lambda enviromnent
        lambdaFunc.addEnvironment('DB_HOST', DB_HOST);
        lambdaFunc.addEnvironment('DB_NAME', DB_NAME);
        lambdaFunc.addEnvironment('DB_USER', DB_USER);
        lambdaFunc.addEnvironment('DB_PASSWORD', DB_PASSWORD);
        lambdaFunc.addEnvironment('WORDPRESS_PATH', WORDPRESS_PATH);
        lambdaFunc.addEnvironment('HTTP_HOST', HTTP_HOST);
        // create EC2 which used to install wordpress files to EFS
        const amznLinux = ec2.MachineImage.latestAmazonLinux({
            generation: ec2.AmazonLinuxGeneration.AMAZON_LINUX,
            edition: ec2.AmazonLinuxEdition.STANDARD,
            virtualization: ec2.AmazonLinuxVirt.HVM,
            storage: ec2.AmazonLinuxStorage.GENERAL_PURPOSE,
        });
        const ec2EFS = new ec2.Instance(this, 'efsInstance', {
            vpc: serverlessVPC,
            vpcSubnets: { subnetType: ec2.SubnetType.PUBLIC },
            machineImage: amznLinux,
            instanceType: new ec2.InstanceType('t2.large'),
            securityGroup: ec2SG,
            keyName: KEY_NAME,
        });
        ec2EFS.userData.addCommands(
        //install efs tool and create mount point
        'sudo yum install -y amazon-efs-utils', 'sudo mkdir /mnt', 'sudo mkdir /mnt/efs');
        new cdk.CfnOutput(this, 'outputEFS', {
            description: 'efs id',
            value: 'efs id: ' + fileSystem.fileSystemId,
        });
        new cdk.CfnOutput(this, 'outputALBDNS', {
            description: 'alb dns name',
            value: 'alb dns name: ' + lb.loadBalancerDnsName,
        });
    }
}
exports.LambdaWordpressStack = LambdaWordpressStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhX3dvcmRwcmVzcy1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxhbWJkYV93b3JkcHJlc3Mtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQXFDO0FBQ3JDLHdDQUF3QztBQUN4Qyx3Q0FBd0M7QUFDeEMsOENBQThDO0FBQzlDLHdDQUF3QztBQUN4Qyw2REFBNkQ7QUFDN0QsdUVBQXVFO0FBQ3ZFLHNEQUFzRDtBQUN0RCxvRkFBK0c7QUFDL0csNkJBQTZCO0FBQzdCLE1BQWEsb0JBQXFCLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFDakQsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDbkIsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQztRQUM1QixNQUFNLE9BQU8sR0FBRyxlQUFlLENBQUM7UUFDaEMsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDO1FBQzdCLE1BQU0sZ0JBQWdCLEdBQUcsWUFBWSxDQUFDO1FBQ3RDLE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQztRQUNsQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNwRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUMxRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUUxRCxxQkFBcUI7UUFDckIsTUFBTSxhQUFhLEdBQUcsSUFBSSxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxlQUFlLEVBQUM7WUFDN0QsVUFBVSxFQUFFLFdB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KiBhcyBlYzIgZnJvbSAnQGF3cy1jZGsvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBlZnMgZnJvbSAnQGF3cy1jZGsvYXdzLWVmcyc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnQGF3cy1jZGsvYXdzLWxhbWJkYSc7XG5pbXBvcnQgKiBhcyByZHMgZnJvbSAnQGF3cy1jZGsvYXdzLXJkcyc7XG5pbXBvcnQgKiBhcyBlbGJ2MiBmcm9tICdAYXdzLWNkay9hd3MtZWxhc3RpY2xvYWRiYWxhbmNpbmd2Mic7XG5pbXBvcnQgKiBhcyB0YXJnZXRzIGZyb20gJ0Bhd3MtY2RrL2F3cy1lbGFzdGljbG9hZGJhbGFuY2luZ3YyLXRhcmdldHMnO1xuaW1wb3J0ICogYXMgY20gZnJvbSAnQGF3cy1jZGsvYXdzLWNlcnRpZmljYXRlbWFuYWdlcic7XG5pbXBvcnQge0FwcGxpY2F0aW9uVGFyZ2V0R3JvdXAsIEFwcGxpY2F0aW9uUHJvdG9jb2wsIExpc3RlbmVyQWN0aW9ufSBmcm9tICdAYXdzLWNkay9hd3MtZWxhc3RpY2xvYWRiYWxhbmNpbmd2MidcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5leHBvcnQgY2xhc3MgTGFtYmRhV29yZHByZXNzU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBjZGsuU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgdmFyIERCX0hPU1QgPSBudWxsO1xuICAgIHZhciBIVFRQX0hPU1QgPSBudWxsO1xuICAgIGNvbnN0IERCX05BTUUgPSAnd29yZHByZXNzJztcbiAgICBjb25zdCBEQl9VU0VSID0gJ3dvcmRwcmVzc3VzZXInO1xuICAgIGNvbnN0IEJBU0VfUEFUSCA9ICcvbW50L2Vmcyc7XG4gICAgY29uc3QgQUNDRVNTUE9JTlRfUEFUSCA9ICcvd29yZHByZXNzJztcbiAgICBjb25zdCBXT1JEUFJFU1NfUEFUSCA9ICcvbW50L2Vmcyc7XG4gICAgY29uc3QgS0VZX05BTUUgPSB0aGlzLm5vZGUudHJ5R2V0Q29udGV4dCgna2V5TmFtZScpO1xuICAgIGNvbnN0IERPTUFJTl9OQU1FID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoJ2RvbWFpbk5hbWUnKTtcbiAgICBjb25zdCBEQl9QQVNTV09SRCA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KCdkYlBhc3N3b3JkJyk7XG5cbiAgICAvL3NldCB0aGUgY2VydGlmaWNhdGVcbiAgICBjb25zdCBteUNlcnRpZmljYXRlID0gbmV3IGNtLkNlcnRpZmljYXRlKHRoaXMsICdteUNlcnRpZmljYXRlJyx7XG4gICAgICBkb21haW5OYW1lOiBET01BSU5fTkFNRSxcbiAgICAgIHZhbGlkYXRpb246IGNtLkNlcnRpZmljYXRlVmFsaWRhdGlvbi5mcm9tRG5zKCksXG4gICAgfSk7XG5cbiAgICAvL2NyZWF0ZSBWUEMgXG4gICAgY29uc3Qgc2VydmVybGVzc1ZQQyA9IG5ldyBlYzIuVnBjKHRoaXMsICdzZXJ2ZXJsZXNzV29yZHByZXNzVlBDJywge1xuICAgICAgY2lkcjogJzEwLjAuMC4wLzE2JyxcbiAgICAgIHN1Ym5ldENvbmZpZ3VyYXRpb246IFtcbiAgICAgICAge1xuICAgICAgICAgIHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBVQkxJQyxcbiAgICAgICAgICBuYW1lOiAncHVibGljJyxcbiAgICAgICAgICBjaWRyTWFzazogMjQsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBjaWRyTWFzazogMjQsXG4gICAgICAgICAgbmFtZTogJ3ByaXZhdGUnLFxuICAgICAgICAgIHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBSSVZBVEUsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pO1xuXG4gICAgLyoqXG4gICAgICogY3JlYXRlIHNlY3VyaXR5IGdyb3VwIGluIFZQQ1xuICAgICAqL1xuICAgIC8vIE5GUyBzZWN1cml0eSBncm91cCB3aGljaCB1c2VkIGZvciBlYzIgdG8gY29weSBmaWxlXG4gICAgY29uc3Qgc2dORlNTRyA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCAnTkZTQWxsb3dBbGxTRycsIHtcbiAgICAgIHZwYzogc2VydmVybGVzc1ZQQyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnYWxsb3cgMjA0OSBpbmJvdW5kIGZvciBlYzInLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZSxcbiAgICB9KTtcbiAgICBzZ05GU1NHLmFkZEluZ3Jlc3NSdWxlKGVjMi5QZWVyLmFueUlwdjQoKSwgZWMyLlBvcnQudGNwKDIwNDkpLCAnYWxsb3cgMjA0OSBpbmJvdW5kIGZyb20gZWMyJylcblxuICAgIC8vQUxCIHNlY3VyaXR5IGdyb3VwIHdoaWNoIGFsbG93IDgwIGFuZCA0NDNcbiAgICBjb25zdCBhbGJTRyA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCAnYWxiU0cnLCB7XG4gICAgICB2cGM6IHNlcnZlcmxlc3NWUEMsXG4gICAgICBkZXNjcmlwdGlvbjogJ2FsbG93IDgwIGFuZCA0NDMnLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZSxcbiAgICB9KTtcbiAgICBhbGJTRy5hZGRJbmdyZXNzUnVsZShlYzIuUGVlci5hbnlJcHY0KCksIGVjMi5Qb3J0LnRjcCg4MCksICdhbGxvdyA4MCBpbmJvdW5kJyk7XG4gICAgYWxiU0cuYWRkSW5ncmVzc1J1bGUoZWMyLlBlZXIuYW55SXB2NCgpLCBlYzIuUG9ydC50Y3AoNDQzKSwgJ2FsbG93IDQ0MyBpbmJvdW5kJyk7XG5cbiAgICAvL0VDMiBzZWN1cml0eSBncm91cCB3aGljaCBhbGxvdyBwb3J0IDIyXG4gICAgY29uc3QgZWMyU0cgPSBuZXcgZWMyLlNlY3VyaXR5R3JvdXAodGhpcywgJ2VjMlNHJywge1xuICAgICAgdnBjOiBzZXJ2ZXJsZXNzVlBDLFxuICAgICAgZGVzY3JpcHRpb246ICdhbGxvdyAyMiBpbmJvdW5kIGZvciBlYzInLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZSxcbiAgICB9KTtcbiAgICBlYzJTRy5hZGRJbmdyZXNzUnVsZShlYzIuUGVlci5hbnlJcHY0KCksIGVjMi5Qb3J0LnRjcCgyMiksICdhbGxvdyAyMiBpbmJvdW5kIGZyb20gZWMyJylcblxuICAgIC8vIFJEUyBzZWN1cml0eSBncm91cCB3aGljaCBhbGxvdyBwb3J0IDMzMDZcbiAgICBjb25zdCByZHNTRyA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCAnd29yZHByZXNzUmRzU2VjdXJpdHlHcm91cCcsIHtcbiAgICAgIHZwYzogc2VydmVybGVzc1ZQQyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnYWxsb3cgMzMwNiBpbmJvdW5kJyxcbiAgICAgIGFsbG93QWxsT3V0Ym91bmQ6IHRydWUsXG4gICAgfSk7XG4gICAgcmRzU0cuYWRkSW5ncmVzc1J1bGUoZWMyLlBlZXIuYW55SXB2NCgpLCBlYzIuUG9ydC50Y3AoMzMwNiksICdhbGxvdyAzMzA2IGluYm91bmQgZnJvbSBsYW1iZGEnKTtcblxuICAgIC8qKlxuICAgICAqIGNyZWF0ZSBFRlMgYXR0YWNoZWQgb24gTGFtYmRhXG4gICAgICovXG4gICAgY29uc3QgZmlsZVN5c3RlbSA9IG5ldyBlZnMuRmlsZVN5c3RlbSh0aGlzLCAnd29yZHByZXNzRUZTJywge1xuICAgICAgdnBjOiBzZXJ2ZXJsZXNzVlBDLFxuICAgICAgZW5jcnlwdGVkOiBmYWxzZSxcbiAgICAgIHBlcmZvcm1hbmNlTW9kZTogZWZzLlBlcmZvcm1hbmNlTW9kZS5HRU5FUkFMX1BVUlBPU0UsXG4gICAgICB0aHJvdWdocHV0TW9kZTogZWZzLlRocm91Z2hwdXRNb2RlLkJVUlNUSU5HLFxuICAgICAgc2VjdXJpdHlHcm91cDogc2dORlNTRyxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG4gICAgLy9jcmVhdGUgYWNjZXNzIHBvaW50IG9uIGVmc1xuICAgIGNvbnN0IGFjY2Vzc1BvaW50ID0gZmlsZVN5c3RlbS5hZGRBY2Nlc3NQb2ludCgnTGFtYmRhQWNjZXNzUG9pbnQnLCB7XG4gICAgICBwYXRoOiBBQ0NFU1NQT0lOVF9QQVRILFxuICAgICAgY3JlYXRlQWNsOiB7XG4gICAgICAgIG93bmVyVWlkOiAnMTAwMCcsXG4gICAgICAgIG93bmVyR2lkOiAnMTAwMCcsXG4gICAgICAgIHBlcm1pc3Npb25zOiAnMDc3NycsXG4gICAgICB9LFxuICAgICAgcG9zaXhVc2VyOiB7XG4gICAgICAgIHVpZDogJzEwMDAnLFxuICAgICAgICBnaWQ6ICcxMDAwJyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgbGFtYmRhIGZ1bmN0aW9uXG4gICAgICovXG4gICAgY29uc3QgbGFtYmRhRnVuYyA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ3dvcmRwcmVzc0xhbWJkYUZVbmN0aW9uJywge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICdwaHBMYW1iZGFGdW5jJykpLFxuICAgICAgaGFuZGxlcjogJ2hhbmRsZXIucGhwJyxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICB0cmFjaW5nOiBsYW1iZGEuVHJhY2luZy5BQ1RJVkUsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QUk9WSURFRCxcbiAgICAgIGxheWVyczogW2xhbWJkYS5MYXllclZlcnNpb24uZnJvbUxheWVyVmVyc2lvbkFybih0aGlzLCAnY3VzdG9tUGhwTGF5ZXInLCAnYXJuOmF3czpsYW1iZGE6dXMtZWFzdC0xOjg4NzA4MDE2OTQ4MDpsYXllcjpwaHA3MzozJyldLFxuICAgICAgdnBjOiBzZXJ2ZXJsZXNzVlBDLFxuICAgICAgZmlsZXN5c3RlbTogbGFtYmRhLkZpbGVTeXN0ZW0uZnJvbUVmc0FjY2Vzc1BvaW50KGFjY2Vzc1BvaW50LCBCQVNFX1BBVEgpLFxuICAgIH0pO1xuXG4gICAgLypcbiAgICAgKiBjcmVhdGUgYWxiIGFuZCBpbnRlZ3JhdGUgaXQgd2l0aCBsYW1iZGFcbiAgICAgKi9cbiAgICBjb25zdCBsYiA9IG5ldyBlbGJ2Mi5BcHBsaWNhdGlvbkxvYWRCYWxhbmNlcih0aGlzLCAnc2VydmVybGVzc0FMQicsIHtcbiAgICAgIHZwYzogc2VydmVybGVzc1ZQQyxcbiAgICAgIGludGVybmV0RmFjaW5nOiB0cnVlLFxuICAgICAgc2VjdXJpdHlHcm91cDogYWxiU0csXG4gICAgfSk7XG5cbiAgICBjb25zdCBsYW1iZGFUYXJnZXQgPSBuZXcgdGFyZ2V0cy5MYW1iZGFUYXJnZXQobGFtYmRhRnVuYyk7XG4gICAgY29uc3QgYWxiVGFyZ2V0R3JvdXAgPSBuZXcgZWxidjIuQXBwbGljYXRpb25UYXJnZXRHcm91cCh0aGlzLCdhbGJUYXJnZXRHcm91cCcse1xuICAgICAgdGFyZ2V0czogW2xhbWJkYVRhcmdldF0sXG4gICAgfSk7XG4gICAgYWxiVGFyZ2V0R3JvdXAuc2V0QXR0cmlidXRlKCdsYW1iZGEubXVsdGlfdmFsdWVfaGVhZGVycy5lbmFibGVkJywgJ3RydWUnKTtcblxuICAgIGNvbnN0IGxpc3RlbmVyODAgPSBsYi5hZGRMaXN0ZW5lcignTGlzdGVuZXI4MCcsIHtcbiAgICAgIHBvcnQ6IDgwLFxuICAgICAgb3BlbjogdHJ1ZSxcbiAgICB9KTtcbiAgICBsaXN0ZW5lcjgwLmFkZEFjdGlvbignODBhY3Rpb24nLHtcbiAgICAgIGFjdGlvbjogTGlzdGVuZXJBY3Rpb24uZm9yd2FyZChbYWxiVGFyZ2V0R3JvdXBdKVxuICAgIH0pO1xuXG4gICAgY29uc3QgbGlzdGVuZXI0NDMgPSBsYi5hZGRMaXN0ZW5lcignTGlzdGVuZXI0NDMnLCB7XG4gICAgICBwb3J0OiA0NDMsXG4gICAgICBvcGVuOiB0cnVlLFxuICAgICAgY2VydGlmaWNhdGVBcm5zOltteUNlcnRpZmljYXRlLmNlcnRpZmljYXRlQXJuXSxcbiAgICB9KTtcbiAgICBsaXN0ZW5lcjQ0My5hZGRBY3Rpb24oJzQ0M2FjdGlvbicse1xuICAgICAgYWN0aW9uOiBMaXN0ZW5lckFjdGlvbi5mb3J3YXJkKFthbGJUYXJnZXRHcm91cF0pXG4gICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiBjcmVhdGUgUkRTXG4gICAgICovXG5cbiAgICBjb25zdCBzZWNyZXQgPSBjZGsuU2VjcmV0VmFsdWUucGxhaW5UZXh0KERCX1BBU1NXT1JEKTtcbiAgICBjb25zdCBhdXJvcmFTZXJ2ZXJsZXNzQ2x1c3RlciA9IG5ldyByZHMuRGF0YWJhc2VDbHVzdGVyKHRoaXMsICdTZXJ2ZXJsZXNzV29yZHByZXNzQXVyb3JhQ2x1c3RlcicsIHtcbiAgICAgIGVuZ2luZTogcmRzLkRhdGFiYXNlQ2x1c3RlckVuZ2luZS5BVVJPUkFfTVlTUUwsXG4gICAgICBtYXN0ZXJVc2VyOiB7XG4gICAgICAgIHVzZXJuYW1lOiBEQl9VU0VSLFxuICAgICAgICBwYXNzd29yZDogc2VjcmV0LFxuICAgICAgfSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICBpbnN0YW5jZVByb3BzOiB7XG4gICAgICAgIHZwYzogc2VydmVybGVzc1ZQQyxcbiAgICAgICAgc2VjdXJpdHlHcm91cHM6IFtyZHNTR10sXG4gICAgICB9LFxuICAgICAgZGVmYXVsdERhdGFiYXNlTmFtZTogREJfTkFNRSxcbiAgICB9KTtcblxuICAgIC8qKipcbiAgICAgKiAgc2V0IHRoZSBEQl9IT1NUIGFuZCBIVFRQX0hPU1Qgd2hpY2ggd2lsbCB1c2VkIGluIHRoZSBsYW1iZGEgZW52aXJvbm1lbnRcbiAgICAgKi9cbiAgICBEQl9IT1NUID0gYXVyb3JhU2VydmVybGVzc0NsdXN0ZXIuY2x1c3RlckVuZHBvaW50Lmhvc3RuYW1lO1xuICAgIEhUVFBfSE9TVCA9IGxiLmxvYWRCYWxhbmNlckRuc05hbWU7XG5cbiAgICAvL1NFVCBsYW1iZGEgZW52aXJvbW5lbnRcbiAgICBsYW1iZGFGdW5jLmFkZEVudmlyb25tZW50KCdEQl9IT1NUJywgREJfSE9TVCk7XG4gICAgbGFtYmRhRnVuYy5hZGRFbnZpcm9ubWVudCgnREJfTkFNRScsIERCX05BTUUpO1xuICAgIGxhbWJkYUZ1bmMuYWRkRW52aXJvbm1lbnQoJ0RCX1VTRVInLCBEQl9VU0VSKTtcbiAgICBsYW1iZGFGdW5jLmFkZEVudmlyb25tZW50KCdEQl9QQVNTV09SRCcsIERCX1BBU1NXT1JEKTtcbiAgICBsYW1iZGFGdW5jLmFkZEVudmlyb25tZW50KCdXT1JEUFJFU1NfUEFUSCcsIFdPUkRQUkVTU19QQVRIKTtcbiAgICBsYW1iZGFGdW5jLmFkZEVudmlyb25tZW50KCdIVFRQX0hPU1QnLCBIVFRQX0hPU1QpO1xuXG4gICAgLy8gY3JlYXRlIEVDMiB3aGljaCB1c2VkIHRvIGluc3RhbGwgd29yZHByZXNzIGZpbGVzIHRvIEVGU1xuICAgIGNvbnN0IGFtem5MaW51eCA9IGVjMi5NYWNoaW5lSW1hZ2UubGF0ZXN0QW1hem9uTGludXgoe1xuICAgICAgZ2VuZXJhdGlvbjogZWMyLkFtYXpvbkxpbnV4R2VuZXJhdGlvbi5BTUFaT05fTElOVVgsXG4gICAgICBlZGl0aW9uOiBlYzIuQW1hem9uTGludXhFZGl0aW9uLlNUQU5EQVJELFxuICAgICAgdmlydHVhbGl6YXRpb246IGVjMi5BbWF6b25MaW51eFZpcnQuSFZNLFxuICAgICAgc3RvcmFnZTogZWMyLkFtYXpvbkxpbnV4U3RvcmFnZS5HRU5FUkFMX1BVUlBPU0UsXG4gICAgfSk7XG5cbiAgICBjb25zdCBlYzJFRlMgPSBuZXcgZWMyLkluc3RhbmNlKHRoaXMsJ2Vmc0luc3RhbmNlJyx7XG4gICAgICB2cGM6IHNlcnZlcmxlc3NWUEMsXG4gICAgICB2cGNTdWJuZXRzOiB7c3VibmV0VHlwZTplYzIuU3VibmV0VHlwZS5QVUJMSUN9LFxuICAgICAgbWFjaGluZUltYWdlIDogYW16bkxpbnV4LFxuICAgICAgaW5zdGFuY2VUeXBlOiBuZXcgZWMyLkluc3RhbmNlVHlwZSgndDIubGFyZ2UnKSxcbiAgICAgIHNlY3VyaXR5R3JvdXA6IGVjMlNHLFxuICAgICAga2V5TmFtZTpLRVlfTkFNRSxcbiAgICB9KTtcblxuICAgIGVjMkVGUy51c2VyRGF0YS5hZGRDb21tYW5kcyhcbiAgICAgIC8vaW5zdGFsbCBlZnMgdG9vbCBhbmQgY3JlYXRlIG1vdW50IHBvaW50XG4gICAgICAnc3VkbyB5dW0gaW5zdGFsbCAteSBhbWF6b24tZWZzLXV0aWxzJyxcbiAgICAgICdzdWRvIG1rZGlyIC9tbnQnLFxuICAgICAgJ3N1ZG8gbWtkaXIgL21udC9lZnMnLFxuICAgICk7XG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnb3V0cHV0RUZTJywge1xuICAgICAgZGVzY3JpcHRpb246ICdlZnMgaWQnLFxuICAgICAgdmFsdWU6ICdlZnMgaWQ6ICcgK2ZpbGVTeXN0ZW0uZmlsZVN5c3RlbUlkLFxuICAgIH0pO1xuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ291dHB1dEFMQkROUycsIHtcbiAgICAgIGRlc2NyaXB0aW9uOiAnYWxiIGRucyBuYW1lJyxcbiAgICAgIHZhbHVlOiAnYWxiIGRucyBuYW1lOiAnICtsYi5sb2FkQmFsYW5jZXJEbnNOYW1lLFxuICAgIH0pO1xuICB9XG59XG4iXX0=