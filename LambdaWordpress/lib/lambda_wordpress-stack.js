"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LambdaWordpressStack = void 0;
const cdk = require("@aws-cdk/core");
const ec2 = require("@aws-cdk/aws-ec2");
const efs = require("@aws-cdk/aws-efs");
const lambda = require("@aws-cdk/aws-lambda");
const rds = require("@aws-cdk/aws-rds");
const elbv2 = require("@aws-cdk/aws-elasticloadbalancingv2");
const targets = require("@aws-cdk/aws-elasticloadbalancingv2-targets");
const cm = require("@aws-cdk/aws-certificatemanager");
const aws_elasticloadbalancingv2_1 = require("@aws-cdk/aws-elasticloadbalancingv2");
const path = require("path");
class LambdaWordpressStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        var DB_HOST = null;
        var HTTP_HOST = null;
        const DB_NAME = 'wordpress';
        const DB_USER = 'wordpressuser';
        const BASE_PATH = '/mnt/efs';
        const ACCESSPOINT_PATH = '/wordpress';
        const WORDPRESS_PATH = '/mnt/efs';
        const KEY_NAME = this.node.tryGetContext('keyName');
        const DOMAIN_NAME = this.node.tryGetContext('domainName');
        const DB_PASSWORD = this.node.tryGetContext('dbPassword');
        //set the certificate
        const myCertificate = new cm.Certificate(this, 'myCertificate', {
            domainName: DOMAIN_NAME,
            validation: cm.CertificateValidation.fromDns(),
        });
        //create VPC 
        const serverlessVPC = new ec2.Vpc(this, 'serverlessWordpressVPC', {
            cidr: '10.0.0.0/16',
            subnetConfiguration: [
                {
                    subnetType: ec2.SubnetType.PUBLIC,
                    name: 'public',
                    cidrMask: 24,
                },
                {
                    cidrMask: 24,
                    name: 'private',
                    subnetType: ec2.SubnetType.PRIVATE,
                },
            ],
        });
        /**
         * create security group in VPC
         */
        // NFS security group which used for ec2 to copy file
        const sgNFSSG = new ec2.SecurityGroup(this, 'NFSAllowAllSG', {
            vpc: serverlessVPC,
            description: 'allow 2049 inbound for ec2',
            allowAllOutbound: true,
        });
        sgNFSSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(2049), 'allow 2049 inbound from ec2');
        //ALB security group which allow 80 and 443
        const albSG = new ec2.SecurityGroup(this, 'albSG', {
            vpc: serverlessVPC,
            description: 'allow 80 and 443',
            allowAllOutbound: true,
        });
        albSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(80), 'allow 80 inbound');
        albSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(443), 'allow 443 inbound');
        //EC2 security group which allow port 22
        const ec2SG = new ec2.SecurityGroup(this, 'ec2SG', {
            vpc: serverlessVPC,
            description: 'allow 22 inbound for ec2',
            allowAllOutbound: true,
        });
        ec2SG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(22), 'allow 22 inbound from ec2');
        // RDS security group which allow port 3306
        const rdsSG = new ec2.SecurityGroup(this, 'wordpressRdsSecurityGroup', {
            vpc: serverlessVPC,
            description: 'allow 3306 inbound',
            allowAllOutbound: true,
        });
        rdsSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(3306), 'allow 3306 inbound from lambda');
        /**
         * create EFS attached on Lambda
         */
        const fileSystem = new efs.FileSystem(this, 'wordpressEFS', {
            vpc: serverlessVPC,
            encrypted: false,
            performanceMode: efs.PerformanceMode.GENERAL_PURPOSE,
            throughputMode: efs.ThroughputMode.BURSTING,
            securityGroup: sgNFSSG,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        //create access point on efs
        const accessPoint = fileSystem.addAccessPoint('LambdaAccessPoint', {
            path: ACCESSPOINT_PATH,
            createAcl: {
                ownerUid: '1000',
                ownerGid: '1000',
                permissions: '0777',
            },
            posixUser: {
                uid: '1000',
                gid: '1000',
            },
        });
        /**
         * Create lambda function
         */
        const lambdaFunc = new lambda.Function(this, 'wordpressLambdaFUnction', {
            code: lambda.Code.fromAsset(path.join(__dirname, 'phpLambdaFunc')),
            handler: 'handler.php',
            memorySize: 1024,
            timeout: cdk.Duration.minutes(15),
            tracing: lambda.Tracing.ACTIVE,
            runtime: lambda.Runtime.PROVIDED,
            layers: [lambda.LayerVersion.fromLayerVersionArn(this, 'customPhpLayer', 'arn:aws:lambda:us-east-1:887080169480:layer:php73:3')],
            vpc: serverlessVPC,
            filesystem: lambda.FileSystem.fromEfsAccessPoint(accessPoint, BASE_PATH),
        });
        /*
         * create alb and integrate it with lambda
         */
        const lb = new elbv2.ApplicationLoadBalancer(this, 'serverlessALB', {
            vpc: serverlessVPC,
            internetFacing: true,
            securityGroup: albSG,
        });
        const lambdaTarget = new targets.LambdaTarget(lambdaFunc);
        const albTargetGroup = new elbv2.ApplicationTargetGroup(this, 'albTargetGroup', {
            targets: [lambdaTarget],
        });
        albTargetGroup.setAttribute('lambda.multi_value_headers.enabled', 'true');
        const listener80 = lb.addListener('Listener80', {
            port: 80,
            open: true,
        });
        listener80.addAction('80action', {
            action: aws_elasticloadbalancingv2_1.ListenerAction.forward([albTargetGroup])
        });
        const listener443 = lb.addListener('Listener443', {
            port: 443,
            open: true,
            certificateArns: [myCertificate.certificateArn],
        });
        listener443.addAction('443action', {
            action: aws_elasticloadbalancingv2_1.ListenerAction.forward([albTargetGroup])
        });
        /**
         * create RDS
         */
        const secret = cdk.SecretValue.plainText(DB_PASSWORD);
        const auroraServerlessCluster = new rds.DatabaseCluster(this, 'ServerlessWordpressAuroraCluster', {
            engine: rds.DatabaseClusterEngine.AURORA_MYSQL,
            credentials: rds.Credentials.fromPassword(DB_USER, secret),
            removalPolicy: cdk.RemovalPolicy.DESTROY,
            instanceProps: {
                vpc: serverlessVPC,
                securityGroups: [rdsSG],
            },
            defaultDatabaseName: DB_NAME,
        });
        /***
         *  set the DB_HOST and HTTP_HOST which will used in the lambda environment
         */
        DB_HOST = auroraServerlessCluster.clusterEndpoint.hostname;
        HTTP_HOST = lb.loadBalancerDnsName;
        //SET lambda enviromnent
        lambdaFunc.addEnvironment('DB_HOST', DB_HOST);
        lambdaFunc.addEnvironment('DB_NAME', DB_NAME);
        lambdaFunc.addEnvironment('DB_USER', DB_USER);
        lambdaFunc.addEnvironment('DB_PASSWORD', DB_PASSWORD);
        lambdaFunc.addEnvironment('WORDPRESS_PATH', WORDPRESS_PATH);
        lambdaFunc.addEnvironment('HTTP_HOST', HTTP_HOST);
        // create EC2 which used to install wordpress files to EFS
        const amznLinux = ec2.MachineImage.latestAmazonLinux({
            generation: ec2.AmazonLinuxGeneration.AMAZON_LINUX,
            edition: ec2.AmazonLinuxEdition.STANDARD,
            virtualization: ec2.AmazonLinuxVirt.HVM,
            storage: ec2.AmazonLinuxStorage.GENERAL_PURPOSE,
        });
        const ec2EFS = new ec2.Instance(this, 'efsInstance', {
            vpc: serverlessVPC,
            vpcSubnets: { subnetType: ec2.SubnetType.PUBLIC },
            machineImage: amznLinux,
            instanceType: new ec2.InstanceType('t2.large'),
            securityGroup: ec2SG,
            keyName: KEY_NAME,
        });
        ec2EFS.userData.addCommands(
        //install efs tool and create mount point
        'sudo yum install -y amazon-efs-utils', 'sudo mkdir /mnt', 'sudo mkdir /mnt/efs');
        new cdk.CfnOutput(this, 'outputEFS', {
            description: 'efs id',
            value: 'efs id: ' + fileSystem.fileSystemId,
        });
        new cdk.CfnOutput(this, 'outputALBDNS', {
            description: 'alb dns name',
            value: 'alb dns name: ' + lb.loadBalancerDnsName,
        });
    }
}
exports.LambdaWordpressStack = LambdaWordpressStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhX3dvcmRwcmVzcy1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxhbWJkYV93b3JkcHJlc3Mtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQXFDO0FBQ3JDLHdDQUF3QztBQUN4Qyx3Q0FBd0M7QUFDeEMsOENBQThDO0FBQzlDLHdDQUF3QztBQUN4Qyw2REFBNkQ7QUFDN0QsdUVBQXVFO0FBQ3ZFLHNEQUFzRDtBQUN0RCxvRkFBK0c7QUFDL0csNkJBQTZCO0FBQzdCLE1BQWEsb0JBQXFCLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFDakQsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDbkIsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQztRQUM1QixNQUFNLE9BQU8sR0FBRyxlQUFlLENBQUM7UUFDaEMsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDO1FBQzdCLE1BQU0sZ0JBQWdCLEdBQUcsWUFBWSxDQUFDO1FBQ3RDLE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQztRQUNsQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNwRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUMxRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUUxRCxxQkFBcUI7UUFDckIsTUFBTSxhQUFhLEdBQUcsSUFBSSxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxlQUFlLEVBQUM7WUFDN0QsVUFBVSxFQUFFLFdB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dCAqIGFzIGVjMiBmcm9tICdAYXdzLWNkay9hd3MtZWMyJztcbmltcG9ydCAqIGFzIGVmcyBmcm9tICdAYXdzLWNkay9hd3MtZWZzJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIHJkcyBmcm9tICdAYXdzLWNkay9hd3MtcmRzJztcbmltcG9ydCAqIGFzIGVsYnYyIGZyb20gJ0Bhd3MtY2RrL2F3cy1lbGFzdGljbG9hZGJhbGFuY2luZ3YyJztcbmltcG9ydCAqIGFzIHRhcmdldHMgZnJvbSAnQGF3cy1jZGsvYXdzLWVsYXN0aWNsb2FkYmFsYW5jaW5ndjItdGFyZ2V0cyc7XG5pbXBvcnQgKiBhcyBjbSBmcm9tICdAYXdzLWNkay9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyJztcbmltcG9ydCB7QXBwbGljYXRpb25UYXJnZXRHcm91cCwgQXBwbGljYXRpb25Qcm90b2NvbCwgTGlzdGVuZXJBY3Rpb259IGZyb20gJ0Bhd3MtY2RrL2F3cy1lbGFzdGljbG9hZGJhbGFuY2luZ3YyJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmV4cG9ydCBjbGFzcyBMYW1iZGFXb3JkcHJlc3NTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICB2YXIgREJfSE9TVCA9IG51bGw7XG4gICAgdmFyIEhUVFBfSE9TVCA9IG51bGw7XG4gICAgY29uc3QgREJfTkFNRSA9ICd3b3JkcHJlc3MnO1xuICAgIGNvbnN0IERCX1VTRVIgPSAnd29yZHByZXNzdXNlcic7XG4gICAgY29uc3QgQkFTRV9QQVRIID0gJy9tbnQvZWZzJztcbiAgICBjb25zdCBBQ0NFU1NQT0lOVF9QQVRIID0gJy93b3JkcHJlc3MnO1xuICAgIGNvbnN0IFdPUkRQUkVTU19QQVRIID0gJy9tbnQvZWZzJztcbiAgICBjb25zdCBLRVlfTkFNRSA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KCdrZXlOYW1lJyk7XG4gICAgY29uc3QgRE9NQUlOX05BTUUgPSB0aGlzLm5vZGUudHJ5R2V0Q29udGV4dCgnZG9tYWluTmFtZScpO1xuICAgIGNvbnN0IERCX1BBU1NXT1JEID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoJ2RiUGFzc3dvcmQnKTtcblxuICAgIC8vc2V0IHRoZSBjZXJ0aWZpY2F0ZVxuICAgIGNvbnN0IG15Q2VydGlmaWNhdGUgPSBuZXcgY20uQ2VydGlmaWNhdGUodGhpcywgJ215Q2VydGlmaWNhdGUnLHtcbiAgICAgIGRvbWFpbk5hbWU6IERPTUFJTl9OQU1FLFxuICAgICAgdmFsaWRhdGlvbjogY20uQ2VydGlmaWNhdGVWYWxpZGF0aW9uLmZyb21EbnMoKSxcbiAgICB9KTtcblxuICAgIC8vY3JlYXRlIFZQQyBcbiAgICBjb25zdCBzZXJ2ZXJsZXNzVlBDID0gbmV3IGVjMi5WcGModGhpcywgJ3NlcnZlcmxlc3NXb3JkcHJlc3NWUEMnLCB7XG4gICAgICBjaWRyOiAnMTAuMC4wLjAvMTYnLFxuICAgICAgc3VibmV0Q29uZmlndXJhdGlvbjogW1xuICAgICAgICB7XG4gICAgICAgICAgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFVCTElDLFxuICAgICAgICAgIG5hbWU6ICdwdWJsaWMnLFxuICAgICAgICAgIGNpZHJNYXNrOiAyNCxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGNpZHJNYXNrOiAyNCxcbiAgICAgICAgICBuYW1lOiAncHJpdmF0ZScsXG4gICAgICAgICAgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiBjcmVhdGUgc2VjdXJpdHkgZ3JvdXAgaW4gVlBDXG4gICAgICovXG4gICAgLy8gTkZTIHNlY3VyaXR5IGdyb3VwIHdoaWNoIHVzZWQgZm9yIGVjMiB0byBjb3B5IGZpbGVcbiAgICBjb25zdCBzZ05GU1NHID0gbmV3IGVjMi5TZWN1cml0eUdyb3VwKHRoaXMsICdORlNBbGxvd0FsbFNHJywge1xuICAgICAgdnBjOiBzZXJ2ZXJsZXNzVlBDLFxuICAgICAgZGVzY3JpcHRpb246ICdhbGxvdyAyMDQ5IGluYm91bmQgZm9yIGVjMicsXG4gICAgICBhbGxvd0FsbE91dGJvdW5kOiB0cnVlLFxuICAgIH0pO1xuICAgIHNnTkZTU0cuYWRkSW5ncmVzc1J1bGUoZWMyLlBlZXIuYW55SXB2NCgpLCBlYzIuUG9ydC50Y3AoMjA0OSksICdhbGxvdyAyMDQ5IGluYm91bmQgZnJvbSBlYzInKVxuXG4gICAgLy9BTEIgc2VjdXJpdHkgZ3JvdXAgd2hpY2ggYWxsb3cgODAgYW5kIDQ0M1xuICAgIGNvbnN0IGFsYlNHID0gbmV3IGVjMi5TZWN1cml0eUdyb3VwKHRoaXMsICdhbGJTRycsIHtcbiAgICAgIHZwYzogc2VydmVybGVzc1ZQQyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnYWxsb3cgODAgYW5kIDQ0MycsXG4gICAgICBhbGxvd0FsbE91dGJvdW5kOiB0cnVlLFxuICAgIH0pO1xuICAgIGFsYlNHLmFkZEluZ3Jlc3NSdWxlKGVjMi5QZWVyLmFueUlwdjQoKSwgZWMyLlBvcnQudGNwKDgwKSwgJ2FsbG93IDgwIGluYm91bmQnKTtcbiAgICBhbGJTRy5hZGRJbmdyZXNzUnVsZShlYzIuUGVlci5hbnlJcHY0KCksIGVjMi5Qb3J0LnRjcCg0NDMpLCAnYWxsb3cgNDQzIGluYm91bmQnKTtcblxuICAgIC8vRUMyIHNlY3VyaXR5IGdyb3VwIHdoaWNoIGFsbG93IHBvcnQgMjJcbiAgICBjb25zdCBlYzJTRyA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCAnZWMyU0cnLCB7XG4gICAgICB2cGM6IHNlcnZlcmxlc3NWUEMsXG4gICAgICBkZXNjcmlwdGlvbjogJ2FsbG93IDIyIGluYm91bmQgZm9yIGVjMicsXG4gICAgICBhbGxvd0FsbE91dGJvdW5kOiB0cnVlLFxuICAgIH0pO1xuICAgIGVjMlNHLmFkZEluZ3Jlc3NSdWxlKGVjMi5QZWVyLmFueUlwdjQoKSwgZWMyLlBvcnQudGNwKDIyKSwgJ2FsbG93IDIyIGluYm91bmQgZnJvbSBlYzInKVxuXG4gICAgLy8gUkRTIHNlY3VyaXR5IGdyb3VwIHdoaWNoIGFsbG93IHBvcnQgMzMwNlxuICAgIGNvbnN0IHJkc1NHID0gbmV3IGVjMi5TZWN1cml0eUdyb3VwKHRoaXMsICd3b3JkcHJlc3NSZHNTZWN1cml0eUdyb3VwJywge1xuICAgICAgdnBjOiBzZXJ2ZXJsZXNzVlBDLFxuICAgICAgZGVzY3JpcHRpb246ICdhbGxvdyAzMzA2IGluYm91bmQnLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZSxcbiAgICB9KTtcbiAgICByZHNTRy5hZGRJbmdyZXNzUnVsZShlYzIuUGVlci5hbnlJcHY0KCksIGVjMi5Qb3J0LnRjcCgzMzA2KSwgJ2FsbG93IDMzMDYgaW5ib3VuZCBmcm9tIGxhbWJkYScpO1xuXG4gICAgLyoqXG4gICAgICogY3JlYXRlIEVGUyBhdHRhY2hlZCBvbiBMYW1iZGFcbiAgICAgKi9cbiAgICBjb25zdCBmaWxlU3lzdGVtID0gbmV3IGVmcy5GaWxlU3lzdGVtKHRoaXMsICd3b3JkcHJlc3NFRlMnLCB7XG4gICAgICB2cGM6IHNlcnZlcmxlc3NWUEMsXG4gICAgICBlbmNyeXB0ZWQ6IGZhbHNlLFxuICAgICAgcGVyZm9ybWFuY2VNb2RlOiBlZnMuUGVyZm9ybWFuY2VNb2RlLkdFTkVSQUxfUFVSUE9TRSxcbiAgICAgIHRocm91Z2hwdXRNb2RlOiBlZnMuVGhyb3VnaHB1dE1vZGUuQlVSU1RJTkcsXG4gICAgICBzZWN1cml0eUdyb3VwOiBzZ05GU1NHLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcbiAgICAvL2NyZWF0ZSBhY2Nlc3MgcG9pbnQgb24gZWZzXG4gICAgY29uc3QgYWNjZXNzUG9pbnQgPSBmaWxlU3lzdGVtLmFkZEFjY2Vzc1BvaW50KCdMYW1iZGFBY2Nlc3NQb2ludCcsIHtcbiAgICAgIHBhdGg6IEFDQ0VTU1BPSU5UX1BBVEgsXG4gICAgICBjcmVhdGVBY2w6IHtcbiAgICAgICAgb3duZXJVaWQ6ICcxMDAwJyxcbiAgICAgICAgb3duZXJHaWQ6ICcxMDAwJyxcbiAgICAgICAgcGVybWlzc2lvbnM6ICcwNzc3JyxcbiAgICAgIH0sXG4gICAgICBwb3NpeFVzZXI6IHtcbiAgICAgICAgdWlkOiAnMTAwMCcsXG4gICAgICAgIGdpZDogJzEwMDAnLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBsYW1iZGEgZnVuY3Rpb25cbiAgICAgKi9cbiAgICBjb25zdCBsYW1iZGFGdW5jID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnd29yZHByZXNzTGFtYmRhRlVuY3Rpb24nLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ3BocExhbWJkYUZ1bmMnKSksXG4gICAgICBoYW5kbGVyOiAnaGFuZGxlci5waHAnLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBST1ZJREVELFxuICAgICAgbGF5ZXJzOiBbbGFtYmRhLkxheWVyVmVyc2lvbi5mcm9tTGF5ZXJWZXJzaW9uQXJuKHRoaXMsICdjdXN0b21QaHBMYXllcicsICdhcm46YXdzOmxhbWJkYTp1cy1lYXN0LTE6ODg3MDgwMTY5NDgwOmxheWVyOnBocDczOjMnKV0sXG4gICAgICB2cGM6IHNlcnZlcmxlc3NWUEMsXG4gICAgICBmaWxlc3lzdGVtOiBsYW1iZGEuRmlsZVN5c3RlbS5mcm9tRWZzQWNjZXNzUG9pbnQoYWNjZXNzUG9pbnQsIEJBU0VfUEFUSCksXG4gICAgfSk7XG5cbiAgICAvKlxuICAgICAqIGNyZWF0ZSBhbGIgYW5kIGludGVncmF0ZSBpdCB3aXRoIGxhbWJkYVxuICAgICAqL1xuICAgIGNvbnN0IGxiID0gbmV3IGVsYnYyLkFwcGxpY2F0aW9uTG9hZEJhbGFuY2VyKHRoaXMsICdzZXJ2ZXJsZXNzQUxCJywge1xuICAgICAgdnBjOiBzZXJ2ZXJsZXNzVlBDLFxuICAgICAgaW50ZXJuZXRGYWNpbmc6IHRydWUsXG4gICAgICBzZWN1cml0eUdyb3VwOiBhbGJTRyxcbiAgICB9KTtcblxuICAgIGNvbnN0IGxhbWJkYVRhcmdldCA9IG5ldyB0YXJnZXRzLkxhbWJkYVRhcmdldChsYW1iZGFGdW5jKTtcbiAgICBjb25zdCBhbGJUYXJnZXRHcm91cCA9IG5ldyBlbGJ2Mi5BcHBsaWNhdGlvblRhcmdldEdyb3VwKHRoaXMsJ2FsYlRhcmdldEdyb3VwJyx7XG4gICAgICB0YXJnZXRzOiBbbGFtYmRhVGFyZ2V0XSxcbiAgICB9KTtcbiAgICBhbGJUYXJnZXRHcm91cC5zZXRBdHRyaWJ1dGUoJ2xhbWJkYS5tdWx0aV92YWx1ZV9oZWFkZXJzLmVuYWJsZWQnLCAndHJ1ZScpO1xuXG4gICAgY29uc3QgbGlzdGVuZXI4MCA9IGxiLmFkZExpc3RlbmVyKCdMaXN0ZW5lcjgwJywge1xuICAgICAgcG9ydDogODAsXG4gICAgICBvcGVuOiB0cnVlLFxuICAgIH0pO1xuICAgIGxpc3RlbmVyODAuYWRkQWN0aW9uKCc4MGFjdGlvbicse1xuICAgICAgYWN0aW9uOiBMaXN0ZW5lckFjdGlvbi5mb3J3YXJkKFthbGJUYXJnZXRHcm91cF0pXG4gICAgfSk7XG5cbiAgICBjb25zdCBsaXN0ZW5lcjQ0MyA9IGxiLmFkZExpc3RlbmVyKCdMaXN0ZW5lcjQ0MycsIHtcbiAgICAgIHBvcnQ6IDQ0MyxcbiAgICAgIG9wZW46IHRydWUsXG4gICAgICBjZXJ0aWZpY2F0ZUFybnM6W215Q2VydGlmaWNhdGUuY2VydGlmaWNhdGVBcm5dLFxuICAgIH0pO1xuICAgIGxpc3RlbmVyNDQzLmFkZEFjdGlvbignNDQzYWN0aW9uJyx7XG4gICAgICBhY3Rpb246IExpc3RlbmVyQWN0aW9uLmZvcndhcmQoW2FsYlRhcmdldEdyb3VwXSlcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIGNyZWF0ZSBSRFNcbiAgICAgKi9cblxuICAgIGNvbnN0IHNlY3JldCA9IGNkay5TZWNyZXRWYWx1ZS5wbGFpblRleHQoREJfUEFTU1dPUkQpO1xuICAgIGNvbnN0IGF1cm9yYVNlcnZlcmxlc3NDbHVzdGVyID0gbmV3IHJkcy5EYXRhYmFzZUNsdXN0ZXIodGhpcywgJ1NlcnZlcmxlc3NXb3JkcHJlc3NBdXJvcmFDbHVzdGVyJywge1xuICAgICAgZW5naW5lOiByZHMuRGF0YWJhc2VDbHVzdGVyRW5naW5lLkFVUk9SQV9NWVNRTCxcbiAgICAgIGNyZWRlbnRpYWxzOiByZHMuQ3JlZGVudGlhbHMuZnJvbVBhc3N3b3JkKERCX1VTRVIsc2VjcmV0KSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICBpbnN0YW5jZVByb3BzOiB7XG4gICAgICAgIHZwYzogc2VydmVybGVzc1ZQQyxcbiAgICAgICAgc2VjdXJpdHlHcm91cHM6IFtyZHNTR10sXG4gICAgICB9LFxuICAgICAgZGVmYXVsdERhdGFiYXNlTmFtZTogREJfTkFNRSxcbiAgICB9KTtcblxuICAgIC8qKipcbiAgICAgKiAgc2V0IHRoZSBEQl9IT1NUIGFuZCBIVFRQX0hPU1Qgd2hpY2ggd2lsbCB1c2VkIGluIHRoZSBsYW1iZGEgZW52aXJvbm1lbnRcbiAgICAgKi9cbiAgICBEQl9IT1NUID0gYXVyb3JhU2VydmVybGVzc0NsdXN0ZXIuY2x1c3RlckVuZHBvaW50Lmhvc3RuYW1lO1xuICAgIEhUVFBfSE9TVCA9IGxiLmxvYWRCYWxhbmNlckRuc05hbWU7XG5cbiAgICAvL1NFVCBsYW1iZGEgZW52aXJvbW5lbnRcbiAgICBsYW1iZGFGdW5jLmFkZEVudmlyb25tZW50KCdEQl9IT1NUJywgREJfSE9TVCk7XG4gICAgbGFtYmRhRnVuYy5hZGRFbnZpcm9ubWVudCgnREJfTkFNRScsIERCX05BTUUpO1xuICAgIGxhbWJkYUZ1bmMuYWRkRW52aXJvbm1lbnQoJ0RCX1VTRVInLCBEQl9VU0VSKTtcbiAgICBsYW1iZGFGdW5jLmFkZEVudmlyb25tZW50KCdEQl9QQVNTV09SRCcsIERCX1BBU1NXT1JEKTtcbiAgICBsYW1iZGFGdW5jLmFkZEVudmlyb25tZW50KCdXT1JEUFJFU1NfUEFUSCcsIFdPUkRQUkVTU19QQVRIKTtcbiAgICBsYW1iZGFGdW5jLmFkZEVudmlyb25tZW50KCdIVFRQX0hPU1QnLCBIVFRQX0hPU1QpO1xuXG4gICAgLy8gY3JlYXRlIEVDMiB3aGljaCB1c2VkIHRvIGluc3RhbGwgd29yZHByZXNzIGZpbGVzIHRvIEVGU1xuICAgIGNvbnN0IGFtem5MaW51eCA9IGVjMi5NYWNoaW5lSW1hZ2UubGF0ZXN0QW1hem9uTGludXgoe1xuICAgICAgZ2VuZXJhdGlvbjogZWMyLkFtYXpvbkxpbnV4R2VuZXJhdGlvbi5BTUFaT05fTElOVVgsXG4gICAgICBlZGl0aW9uOiBlYzIuQW1hem9uTGludXhFZGl0aW9uLlNUQU5EQVJELFxuICAgICAgdmlydHVhbGl6YXRpb246IGVjMi5BbWF6b25MaW51eFZpcnQuSFZNLFxuICAgICAgc3RvcmFnZTogZWMyLkFtYXpvbkxpbnV4U3RvcmFnZS5HRU5FUkFMX1BVUlBPU0UsXG4gICAgfSk7XG5cbiAgICBjb25zdCBlYzJFRlMgPSBuZXcgZWMyLkluc3RhbmNlKHRoaXMsJ2Vmc0luc3RhbmNlJyx7XG4gICAgICB2cGM6IHNlcnZlcmxlc3NWUEMsXG4gICAgICB2cGNTdWJuZXRzOiB7c3VibmV0VHlwZTplYzIuU3VibmV0VHlwZS5QVUJMSUN9LFxuICAgICAgbWFjaGluZUltYWdlIDogYW16bkxpbnV4LFxuICAgICAgaW5zdGFuY2VUeXBlOiBuZXcgZWMyLkluc3RhbmNlVHlwZSgndDIubGFyZ2UnKSxcbiAgICAgIHNlY3VyaXR5R3JvdXA6IGVjMlNHLFxuICAgICAga2V5TmFtZTpLRVlfTkFNRSxcbiAgICB9KTtcblxuICAgIGVjMkVGUy51c2VyRGF0YS5hZGRDb21tYW5kcyhcbiAgICAgIC8vaW5zdGFsbCBlZnMgdG9vbCBhbmQgY3JlYXRlIG1vdW50IHBvaW50XG4gICAgICAnc3VkbyB5dW0gaW5zdGFsbCAteSBhbWF6b24tZWZzLXV0aWxzJyxcbiAgICAgICdzdWRvIG1rZGlyIC9tbnQnLFxuICAgICAgJ3N1ZG8gbWtkaXIgL21udC9lZnMnLFxuICAgICk7XG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnb3V0cHV0RUZTJywge1xuICAgICAgZGVzY3JpcHRpb246ICdlZnMgaWQnLFxuICAgICAgdmFsdWU6ICdlZnMgaWQ6ICcgK2ZpbGVTeXN0ZW0uZmlsZVN5c3RlbUlkLFxuICAgIH0pO1xuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ291dHB1dEFMQkROUycsIHtcbiAgICAgIGRlc2NyaXB0aW9uOiAnYWxiIGRucyBuYW1lJyxcbiAgICAgIHZhbHVlOiAnYWxiIGRucyBuYW1lOiAnICtsYi5sb2FkQmFsYW5jZXJEbnNOYW1lLFxuICAgIH0pO1xuICB9XG59XG4iXX0=